{"version":3,"file":"js/UpdateImageWizard.97fdad6e10b6a5aac941.js","mappings":"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","sources":["webpack:///./src/Routes/ImageManager/UpdateImageWizard.js"],"sourcesContent":["import React, { useState, useEffect, useContext } from 'react';\nimport ImageCreator from '../../components/ImageCreator';\nimport componentTypes from '@data-driven-forms/react-form-renderer/component-types';\nimport {\n  review,\n  packages,\n  updateDetails,\n  registration,\n  imageOutput,\n} from './steps';\nimport { Spinner } from '@patternfly/react-core';\nimport PropTypes from 'prop-types';\nimport ReviewStep from '../../components/form/ReviewStep';\nimport {\n  createNewImage,\n  addImageToPoll,\n  loadEdgeImages,\n} from '../../store/actions';\nimport { CREATE_NEW_IMAGE_RESET } from '../../store/action-types';\nimport { useDispatch } from 'react-redux';\nimport { useSelector, shallowEqual } from 'react-redux';\nimport { RegistryContext } from '../../store';\nimport { imageDetailReducer } from '../../store/reducers';\nimport { loadImageDetail } from '../../store/actions';\nimport { getEdgeImageStatus, getPackages } from '../../api';\nimport { addNotification } from '@redhat-cloud-services/frontend-components-notifications';\n\nconst UpdateImage = ({ navigateBack, updateImageID }) => {\n  const [user, setUser] = useState();\n  const [packageSummary, setPackageSummary] = useState();\n  const dispatch = useDispatch();\n  const closeAction = () => {\n    navigateBack();\n    dispatch({ type: CREATE_NEW_IMAGE_RESET });\n  };\n\n  const { getRegistry } = useContext(RegistryContext);\n  const { data } = useSelector(\n    ({ imageDetailReducer }) => ({ data: imageDetailReducer?.data || null }),\n    shallowEqual\n  );\n\n  const getPackageSummary = async () => {\n    const packages = data?.Commit?.Packages;\n    if (packages?.length > 0) {\n      const promises = packages.map(async (pkg) => {\n        const { data } = await getPackages('rhel-84', 'x86_64', pkg.Name);\n        const correctPackage = data.find((result) => result.name === pkg.Name);\n        const getSummary = {\n          name: correctPackage.name,\n          summary: correctPackage.summary,\n        };\n\n        return {\n          ...pkg,\n          ...getSummary,\n        };\n      });\n      const results = await Promise.all(promises);\n      setPackageSummary(results);\n    }\n  };\n\n  useEffect(() => {\n    const registered = getRegistry().register({\n      imageDetailReducer,\n    });\n    loadImageDetail(dispatch, updateImageID);\n    return () => registered();\n  }, [dispatch]);\n\n  useEffect(() => {\n    (async () => {\n      const userData = (await insights?.chrome?.auth?.getUser()) || {};\n      setUser(() => userData);\n    })();\n    getPackageSummary();\n  }, []);\n\n  return user ? (\n    <ImageCreator\n      onClose={closeAction}\n      customComponentMapper={{\n        review: ReviewStep,\n      }}\n      onSubmit={({ values, setIsSaving }) => {\n        setIsSaving(() => true);\n        const payload = {\n          ...values,\n          Id: data?.ID,\n          name: data?.Name,\n          version: data?.Version + 1,\n          architecture: 'x86_64',\n          credentials: values.credentials\n            ? values.credentials\n            : data?.Installer.SshKey,\n          username: values.username\n            ? values.username\n            : data?.Installer.Username,\n        };\n\n        createNewImage(dispatch, payload, (resp) => {\n          dispatch({\n            ...addNotification({\n              variant: 'info',\n              title: 'Update image',\n              description: `${resp.value.Name} image was added to the queue.`,\n            }),\n            meta: {\n              polling: {\n                id: `FETCH_IMAGE_${resp.value.ID}_BUILD_STATUS`,\n                fetcher: () => getEdgeImageStatus(resp.value.ID),\n                condition: (resp) => {\n                  switch (resp.Status) {\n                    case 'BUILDING':\n                      return [true, ''];\n                    case 'ERROR':\n                      return [false, 'failure'];\n                    default:\n                      return [false, 'success'];\n                  }\n                },\n                onEvent: {\n                  failure: [\n                    (dispatch) =>\n                      dispatch(\n                        addNotification({\n                          variant: 'danger',\n                          title: 'Image build failed',\n                          description: `${resp.value.Name} image build is completed unsuccessfully`,\n                        })\n                      ),\n                  ],\n                  success: [\n                    (dispatch) =>\n                      dispatch(\n                        addNotification({\n                          variant: 'success',\n                          title: 'Image is ready',\n                          description: `${resp.value.Name} image build is completed`,\n                        })\n                      ),\n                    (dispatch) => loadEdgeImages(dispatch),\n                  ],\n                },\n              },\n            },\n          });\n          closeAction();\n          loadEdgeImages(dispatch);\n          dispatch(\n            addImageToPoll({ name: data.value.Name, id: data.value.ID })\n          );\n        });\n      }}\n      defaultArch=\"x86_64\"\n      initialValues={{\n        name: data?.Name,\n        isUpdate: true,\n        description: data?.Description,\n        credentials: data?.Installer.SshKey,\n        username: data?.Installer.Username,\n        version: data?.Version,\n        imageType: ['rhel-edge-commit'],\n        'selected-packages': packageSummary,\n      }}\n      schema={{\n        fields: [\n          {\n            component: componentTypes.WIZARD,\n            name: 'image-builder-wizard',\n            className: 'image-builder',\n            isDynamic: true,\n            inModal: true,\n            buttonLabels: {\n              submit: 'Create image',\n            },\n            showTitles: true,\n            title: `Update image: ${data?.Name}`,\n            crossroads: ['target-environment', 'release', 'imageType'],\n            // order in this array does not reflect order in wizard nav, this order is managed inside\n            // of each step by `nextStep` property!\n            fields: [\n              updateDetails,\n              imageOutput,\n              registration,\n              packages,\n              review,\n            ],\n          },\n        ],\n      }}\n    />\n  ) : (\n    <Spinner />\n  );\n};\n\nUpdateImage.propTypes = {\n  navigateBack: PropTypes.func,\n  updateImageID: PropTypes.number,\n};\nUpdateImage.defaultProps = {\n  navigateBack: () => undefined,\n};\n\nexport default UpdateImage;\n"],"names":["UpdateImage","navigateBack","updateImageID","useState","user","setUser","packageSummary","setPackageSummary","dispatch","useDispatch","closeAction","type","CREATE_NEW_IMAGE_RESET","getRegistry","useContext","RegistryContext","data","useSelector","imageDetailReducer","shallowEqual","getPackageSummary","packages","Commit","Packages","length","promises","map","pkg","getPackages","Name","correctPackage","find","result","name","getSummary","summary","Promise","all","results","useEffect","registered","register","loadImageDetail","insights","chrome","auth","getUser","userData","onClose","customComponentMapper","review","ReviewStep","onSubmit","values","setIsSaving","payload","Id","ID","version","Version","architecture","credentials","Installer","SshKey","username","Username","createNewImage","resp","addNotification","variant","title","description","value","meta","polling","id","fetcher","getEdgeImageStatus","condition","Status","onEvent","failure","success","loadEdgeImages","addImageToPoll","defaultArch","initialValues","isUpdate","Description","imageType","schema","fields","component","componentTypes","className","isDynamic","inModal","buttonLabels","submit","showTitles","crossroads","updateDetails","imageOutput","registration","propTypes","PropTypes","defaultProps"],"sourceRoot":""}